<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VroomVroomTaRace</title>
    <style>
        .filter {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .filter label {
            margin-right: 8px;
        }
        .filter button {
            margin-left: 8px;
            background-color: red;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }
        .filter button:hover {
            background-color: darkred;
        }
    </style>
</head>
<body>
    <h1>VroomVroomTaRace</h1>
    <p>Recherchez et comparez des véhicules avec des filtres dynamiques.</p>

    <form id="searchForm">
        <label for="makesSelect">Marque:</label>
        <select id="makesSelect">
            <option value="">Sélectionner une marque</option>
        </select>

        <label for="modelsSelect">Modèle:</label>
        <select id="modelsSelect" disabled>
            <option value="">Sélectionner un modèle</option>
        </select>

        <div id="dynamicFilters"></div>

        <label for="filterSelect">Ajouter un filtre:</label>
        <select id="filterSelect">
            <option value="">Sélectionner un filtre</option>
            <option value="year">Année</option>
            <option value="min_power">Puissance minimale (ch)</option>
            <option value="body">Type de carrosserie</option>
            <option value="fuel_type">Type de carburant</option>
            <option value="seats">Nombre de sièges</option>
        </select>

        <button type="button" id="addFilterButton">Ajouter</button>
        <button type="submit">Rechercher</button>
    </form>

    <div id="results">
        <h2>Résultats</h2>
        <ul id="resultsList"></ul>
    </div>

    <script>
        const BASE_URL = "https://www.carqueryapi.com/api/0.3/";

        const makesSelect = document.getElementById("makesSelect");
        const modelsSelect = document.getElementById("modelsSelect");
        const filterSelect = document.getElementById("filterSelect");
        const addFilterButton = document.getElementById("addFilterButton");
        const dynamicFilters = document.getElementById("dynamicFilters");
        const searchForm = document.getElementById("searchForm");
        const resultsList = document.getElementById("resultsList");

        const filterOptions = {
            year: generateYears(),
            min_power: generateMinPower(),
            body: ["Coupe", "Sedan", "SUV", "Pickup", "Crossover", "Minivan"],
            fuel_type: ["Essence", "Diesel", "Électrique", "Hybride"],
            seats: [2, 4, 5, 7],
        };

        function getMakes() {
            fetch(`${BASE_URL}?cmd=getMakes`)
                .then(response => response.json())
                .then(data => {
                    data.Makes.forEach(make => {
                        const option = document.createElement("option");
                        option.value = make.make_id;
                        option.textContent = make.make_display;
                        makesSelect.appendChild(option);
                    });
                });
        }

        function generateYears() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let year = currentYear; year >= 1950; year--) {
                years.push(year);
            }
            return years;
        }

        function generateMinPower() {
            return [50, 100, 150, 200, 250, 300, 350, 400];
        }

        makesSelect.addEventListener("change", () => {
            modelsSelect.innerHTML = "<option value=''>Sélectionner un modèle</option>";
            modelsSelect.disabled = !makesSelect.value;

            if (makesSelect.value) {
                fetch(`${BASE_URL}?cmd=getModels&make=${makesSelect.value}`)
                    .then(response => response.json())
                    .then(data => {
                        data.Models.forEach(model => {
                            const option = document.createElement("option");
                            option.value = model.model_name;
                            option.textContent = model.model_name;
                            modelsSelect.appendChild(option);
                        });
                    });
            }
        });

        addFilterButton.addEventListener("click", () => {
            const selectedFilter = filterSelect.value;

            if (selectedFilter && !document.getElementById(selectedFilter)) {
                const container = document.createElement("div");
                container.classList.add("filter");

                const label = document.createElement("label");
                label.textContent = `${filterSelect.options[filterSelect.selectedIndex].textContent}:`;
                label.setAttribute("for", selectedFilter);

                const input = document.createElement("select");
                input.id = selectedFilter;

                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = `Sélectionner ${label.textContent.toLowerCase()}`;
                input.appendChild(defaultOption);

                filterOptions[selectedFilter].forEach(optionValue => {
                    const option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    input.appendChild(option);
                });

                const removeButton = document.createElement("button");
                removeButton.textContent = "Supprimer";
                removeButton.addEventListener("click", () => {
                    container.remove();
                });

                container.appendChild(label);
                container.appendChild(input);
                container.appendChild(removeButton);
                dynamicFilters.appendChild(container);

                filterSelect.value = "";
            } else {
                alert("Veuillez sélectionner un filtre valide ou un filtre non utilisé !");
            }
        });

        searchForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const make = makesSelect.value;
            const model = modelsSelect.value;

            let query = `${BASE_URL}?cmd=getTrims`;
            if (make) query += `&make=${make}`;
            if (model) query += `&model=${model}`;

            const filterInputs = dynamicFilters.querySelectorAll("select");
            filterInputs.forEach(input => {
                if (input.value) {
                    query += `&${input.id}=${input.value}`;
                }
            });

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    resultsList.innerHTML = "";
                    data.Trims.forEach(trim => {
                        const li = document.createElement("li");
                        li.textContent = `${trim.model_make_display} ${trim.model_name} ${trim.model_trim} - ${trim.model_year} (${trim.model_engine_power_ps} ch)`;
                        resultsList.appendChild(li);
                    });
                });
        });

        getMakes();
    </script>
</body>
</html>
